<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diario Alimentare PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .progress-bar-bg { background-color: #e9ecef; }
        .progress-bar { transition: width 0.6s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8">
    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        
        <!-- Sezione Dashboard PRO -->
        <div id="dashboardSection" class="mb-6 p-6 rounded-2xl shadow-lg bg-white">
            <h2 class="text-xl font-bold mb-4 text-center text-gray-800">Riepilogo Giornaliero</h2>
            <div id="dashboardContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <!-- Kcal -->
                <div class="p-3 rounded-lg bg-blue-50">
                    <p class="text-sm font-semibold text-blue-800">CALORIE</p>
                    <p id="kcalProgressText" class="text-xl font-bold text-blue-900 my-1">0 / 0</p>
                    <div class="w-full bg-blue-200 rounded-full h-2.5">
                        <div id="kcalProgressBar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Proteine -->
                <div class="p-3 rounded-lg bg-green-50">
                    <p class="text-sm font-semibold text-green-800">PROTEINE</p>
                    <p id="proteinProgressText" class="text-xl font-bold text-green-900 my-1">0 / 0 g</p>
                    <div class="w-full bg-green-200 rounded-full h-2.5">
                        <div id="proteinProgressBar" class="bg-green-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Carboidrati -->
                <div class="p-3 rounded-lg bg-yellow-50">
                    <p class="text-sm font-semibold text-yellow-800">CARBOIDRATI</p>
                    <p id="carbsProgressText" class="text-xl font-bold text-yellow-900 my-1">0 / 0 g</p>
                    <div class="w-full bg-yellow-200 rounded-full h-2.5">
                        <div id="carbsProgressBar" class="bg-yellow-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Grassi -->
                <div class="p-3 rounded-lg bg-red-50">
                    <p class="text-sm font-semibold text-red-800">GRASSI</p>
                    <p id="fatProgressText" class="text-xl font-bold text-red-900 my-1">0 / 0 g</p>
                    <div class="w-full bg-red-200 rounded-full h-2.5">
                        <div id="fatProgressBar" class="bg-red-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="scanButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center justify-center gap-2 transition-transform transform hover:scale-105">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                    <span>Scansiona Codice</span>
                </button>
                 <button id="manualEntryButton" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center justify-center gap-2 transition-transform transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    <span>Aggiungi Manualmente</span>
                </button>
            </div>

            <form id="foodForm" class="hidden mt-6 space-y-4 border-t pt-6">
                 <div class="relative">
                    <label for="productName" class="block text-sm font-medium text-gray-700">Nome Prodotto</label>
                    <input type="text" id="productName" name="productName" required autocomplete="off" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    <div id="suggestionsContainer" class="hidden absolute w-full bg-white border rounded-md shadow-lg z-10 mt-1 max-h-48 overflow-y-auto"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Codice a Barre (opzionale)</label>
                    <input type="text" id="barcode" name="barcode" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="date" name="date">
                    <input type="hidden" id="time" name="time">
                    <div>
                        <label for="mealType" class="block text-sm font-medium text-gray-700">Tipo di Pasto</label>
                        <select id="mealType" name="mealType" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            <option>COLAZIONE</option>
                            <option>SPUNTINO DELLA MATTINA</option>
                            <option>PRANZO</option>
                            <option>SPUNTINO DEL POMERIGIO</option>
                            <option>CENA</option>
                            <option>ALTRO</option>
                        </select>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Quantità</label>
                        <input type="text" id="quantity" name="quantity" inputmode="decimal" required placeholder="Es. 150,30" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label for="unitOfMeasure" class="block text-sm font-medium text-gray-700">Unità di Misura</label>
                    <select id="unitOfMeasure" name="unitOfMeasure" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                        <option>gr</option>
                        <option>Kg</option>
                        <option>ml</option>
                        <option>lt</option>
                        <option>pz</option>
                    </select>
                </div>
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700">Note</label>
                    <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <!-- NUOVO FLAG CHECKBOX -->
                <div>
                    <div class="flex items-center">
                        <input id="unmappedFood" name="unmappedFood" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="unmappedFood" class="ml-2 block text-sm text-gray-900">ALIMENTO NON MAPPATO</label>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                        Salva Voce
                    </button>
                    <button type="button" id="cancelButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                        Annulla
                    </button>
                </div>
            </form>

            <div id="statusSection" class="mt-6 hidden">
                <div id="statusMessage" class="p-4 rounded-md text-center"></div>
            </div>

            <!-- Sezione Storico Giornaliero -->
            <div id="dailyLogSection" class="mt-8 border-t pt-6">
                <h2 id="todayTitle" class="text-2xl font-bold text-gray-800 mb-4 text-center"></h2>
                <div id="dailyLogContainer" class="space-y-3">
                    <p class="text-center text-gray-500">Caricamento storico giornaliero...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Scanner Modal (invariato) -->
    <div id="scanner-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-4 relative">
            <h3 class="text-lg font-medium text-center text-gray-900">Inquadra il codice a barre</h3>
            <video id="video" class="w-full h-auto mt-4 rounded-md border"></video>
            <button id="close-scanner" class="absolute top-2 right-2 bg-white rounded-full p-1 text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz9SPYu6JKoQIEZ0md2B35B3OmICa9gGULU6qEm68yj_QdRxe0AfquVu8VHgcCdz0vd/exec';
            
            // Selettori elementi
            const scanButton = document.getElementById('scanButton');
            const manualEntryButton = document.getElementById('manualEntryButton');
            const cancelButton = document.getElementById('cancelButton');
            const foodForm = document.getElementById('foodForm');
            const barcodeInput = document.getElementById('barcode');
            const productNameInput = document.getElementById('productName');
            const quantityInput = document.getElementById('quantity');
            const scannerModal = document.getElementById('scanner-modal');
            const closeScannerButton = document.getElementById('close-scanner');
            const statusSection = document.getElementById('statusSection');
            const statusMessage = document.getElementById('statusMessage');
            const dailyLogContainer = document.getElementById('dailyLogContainer');
            const todayTitleEl = document.getElementById('todayTitle');
            const suggestionsContainer = document.getElementById('suggestionsContainer');

            // Selettori Dashboard
            const kcalProgressText = document.getElementById('kcalProgressText');
            const proteinProgressText = document.getElementById('proteinProgressText');
            const carbsProgressText = document.getElementById('carbsProgressText');
            const fatProgressText = document.getElementById('fatProgressText');
            const kcalProgressBar = document.getElementById('kcalProgressBar');
            const proteinProgressBar = document.getElementById('proteinProgressBar');
            const carbsProgressBar = document.getElementById('carbsProgressBar');
            const fatProgressBar = document.getElementById('fatProgressBar');

            let dailyGoals = {};
            let dailyTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            
            const codeReader = new ZXing.BrowserMultiFormatReader();
            let stream;
            
            function setTodayTitle() {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                todayTitleEl.textContent = `Pasti di Oggi - ${day}/${month}/${year}`;
            }

            function updateDashboardUI() {
                const { kcal, protein, carbs, fat } = dailyGoals;
                const { calories, protein: totalProtein, carbs: totalCarbs, fat: totalFat } = dailyTotals;

                kcalProgressText.textContent = `${calories.toFixed(0)} / ${kcal || 0}`;
                let kcalPercent = (kcal && kcal > 0) ? (calories / kcal) * 100 : 0;
                kcalProgressBar.style.width = `${Math.min(kcalPercent, 100)}%`;

                proteinProgressText.textContent = `${totalProtein.toFixed(1)} / ${protein || 0} g`;
                let proteinPercent = (protein && protein > 0) ? (totalProtein / protein) * 100 : 0;
                proteinProgressBar.style.width = `${Math.min(proteinPercent, 100)}%`;
                
                carbsProgressText.textContent = `${totalCarbs.toFixed(1)} / ${carbs || 0} g`;
                let carbsPercent = (carbs && carbs > 0) ? (totalCarbs / carbs) * 100 : 0;
                carbsProgressBar.style.width = `${Math.min(carbsPercent, 100)}%`;

                fatProgressText.textContent = `${totalFat.toFixed(1)} / ${fat || 0} g`;
                let fatPercent = (fat && fat > 0) ? (totalFat / fat) * 100 : 0;
                fatProgressBar.style.width = `${Math.min(fatPercent, 100)}%`;
            }
            
            async function fetchDashboardData() {
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=getDashboardData`);
                    if (!response.ok) throw new Error('Errore nel caricamento del dashboard');
                    dailyGoals = await response.json();
                    updateDashboardUI();
                } catch (error) {
                    console.error("Errore Dashboard:", error);
                }
            }
            
            function renderLogEntry(entry) {
                const entryId = `entry-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const entryDiv = document.createElement('div');
                entryDiv.id = entryId;
                entryDiv.className = 'p-3 bg-gray-50 rounded-lg border animate-fade-in';
                
                // Legge i nomi delle colonne corretti che arrivano dallo script
                const productName = entry["NOME PRODOTTO"];
                const quantity = entry["QUANTITA'"];
                const unit = entry["UNITA' DI MISURA"];
                const mealType = entry["TIPOLOGIA PASTO"];
                const barcode = entry["BARCODE"];

                entryDiv.innerHTML = `<div class="flex justify-between items-center"> <div><p class="font-semibold text-gray-800">${productName}</p><p class="text-sm text-gray-500">${mealType}</p></div> <div class="text-right"><p class="font-bold text-gray-900">${quantity} ${unit}</p></div> </div>`;
                dailyLogContainer.appendChild(entryDiv);
                return entryId;
            }

            async function fetchDailyLog() {
                dailyLogContainer.innerHTML = '<p class="text-center text-gray-500">Caricamento storico giornaliero...</p>';
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=getDailyLog`);
                    if (!response.ok) throw new Error(`Failed to fetch`);
                    const entries = await response.json();
                    dailyLogContainer.innerHTML = '';
                    
                    if (!Array.isArray(entries) || entries.length === 0) {
                        dailyLogContainer.innerHTML = '<p class="text-center text-gray-500">Nessuna voce registrata per oggi.</p>';
                        return;
                    }
                    entries.forEach(renderLogEntry);

                } catch (error) {
                    console.error("Errore nel caricamento dello storico:", error);
                    dailyLogContainer.innerHTML = `<p class="text-center text-red-600">Impossibile caricare lo storico. <br><small>${error.message}</small></p>`;
                }
            }
            
            foodForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = foodForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = 'Salvataggio in corso...';
                
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                foodForm.querySelector('#date').value = `${day}/${month}/${year}`;
                foodForm.querySelector('#time').value = `${hours}:${minutes}:${seconds}`;
                
                const formData = new FormData(foodForm);
                const newEntry = Object.fromEntries(formData.entries());
                newEntry.unmappedFood = foodForm.querySelector('#unmappedFood').checked ? 'Sì' : 'No';

                try {
                    const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(newEntry), headers: { "Content-Type": "text/plain;charset=utf-8" } });
                    const result = await response.json();
                    if(result.status !== 'success') throw new Error(result.message);
                    
                    statusMessage.textContent = 'Voce salvata con successo!';
                    statusMessage.className = 'p-4 rounded-md text-center bg-green-100 text-green-800';
                    statusSection.classList.remove('hidden');
                    hideForm();
                    await fetchDailyLog(); // Ricarica lo storico completo per mostrare la nuova voce
                
                } catch (error) {
                     statusMessage.textContent = `Errore durante il salvataggio: ${error.message}`;
                    statusMessage.className = 'p-4 rounded-md text-center bg-red-100 text-red-800';
                    statusSection.classList.remove('hidden');
                } finally {
                     submitButton.disabled = false;
                    submitButton.innerHTML = 'Salva Voce';
                }
            });

             async function fetchProductName(barcode) {
                foodForm.classList.remove('hidden');
                barcodeInput.value = barcode;
                productNameInput.value = 'Ricerca nel tuo database...';
                productNameInput.disabled = true;
                try {
                    const apiUrl = `${SCRIPT_URL}?action=getProductName&barcode=${barcode}`;
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('Errore di comunicazione con lo script di Google.');
                    const result = await response.json();
                    if (result.status === 'success') {
                        productNameInput.value = result.productName;
                    } else if (result.status === 'not_found') {
                        productNameInput.value = '';
                        productNameInput.placeholder = 'Prodotto non nel DB, inseriscilo tu';
                    } else {
                        throw new Error(result.message || 'Errore sconosciuto dallo script.');
                    }
                } catch (error) {
                    console.error('Errore durante la ricerca del prodotto:', error);
                    productNameInput.value = '';
                    productNameInput.placeholder = 'Errore. Inserisci manualmente.';
                    statusMessage.textContent = `Errore ricerca prodotto: ${error.message}`;
                    statusMessage.className = 'p-4 rounded-md text-center bg-red-100 text-red-800';
                    statusSection.classList.remove('hidden');
                } finally {
                    productNameInput.disabled = false;
                    productNameInput.focus();
                }
            }
             
             function startScanner() { scannerModal.classList.remove('hidden'); codeReader.listVideoInputDevices().then((videoInputDevices) => { let selectedDeviceId = videoInputDevices[0].deviceId; if (videoInputDevices.length > 1) { const rearCamera = videoInputDevices.find(device => device.label.toLowerCase().includes('back')); if (rearCamera) selectedDeviceId = rearCamera.deviceId; } codeReader.decodeFromVideoStream(selectedDeviceId, 'video', (result, err) => { if (result) { stopScanner(); fetchProductName(result.text); } }).then(controls => { stream = controls.stream; }); }).catch((err) => { alert("Errore fotcamera."); }); }
             function stopScanner() { if (stream) stream.getTracks().forEach(track => track.stop()); codeReader.reset(); scannerModal.classList.add('hidden'); }
             function showForm() { foodForm.reset(); foodForm.classList.remove('hidden'); productNameInput.focus(); }
             function hideForm() { foodForm.classList.add('hidden'); foodForm.reset(); suggestionsContainer.classList.add('hidden'); suggestionsContainer.innerHTML = ''; }
             scanButton.addEventListener('click', startScanner);
             manualEntryButton.addEventListener('click', showForm);
             cancelButton.addEventListener('click', hideForm);
             closeScannerButton.addEventListener('click', stopScanner);
             quantityInput.addEventListener('input', (e) => { let value = e.target.value.replace(/\./g, ',').replace(/[^0-9,]/g, ''); const parts = value.split(','); if (parts.length > 2) value = parts[0] + ',' + parts.slice(1).join(''); e.target.value = value; });

            // LOGICA PER L'AUTOCOMPLETAMENTO
            let autocompleteTimeout;
            productNameInput.addEventListener('input', (e) => {
                const query = e.target.value;
                clearTimeout(autocompleteTimeout);
                
                if (query.length < 2) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                autocompleteTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`${SCRIPT_URL}?action=getProductSuggestions&query=${encodeURIComponent(query)}`);
                        if (!response.ok) {
                            throw new Error(`Errore dal server: ${response.statusText}`);
                        }
                        const suggestions = await response.json();
                        
                        suggestionsContainer.innerHTML = '';
                        if (suggestions.length > 0) {
                            suggestionsContainer.classList.remove('hidden');
                            suggestions.forEach(item => {
                                const div = document.createElement('div');
                                div.textContent = item.name;
                                div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                                div.addEventListener('click', () => {
                                    productNameInput.value = item.name;
                                    barcodeInput.value = item.barcode;
                                    suggestionsContainer.classList.add('hidden');
                                });
                                suggestionsContainer.appendChild(div);
                            });
                        } else {
                            suggestionsContainer.classList.add('hidden');
                        }
                    } catch (error) {
                        console.error("Errore autocompletamento:", error);
                    }
                }, 300);
            });

            document.addEventListener('click', (e) => {
                if (!productNameInput.contains(e.target)) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
            
            async function initializeApp() {
                setTodayTitle();
                await fetchDashboardData(); 
                await fetchDailyLog();      
            }
            
            initializeApp();
        });
    </script>
</body>
</html>